<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | FormCraft</title>
    <link rel="stylesheet" href="../css/adminDashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo-container">
                <img src="https://cdn3.iconfinder.com/data/icons/files-7-1/64/50-512.png" alt="FormCraft Logo">
                <h1>FormCraft</h1>
            </div>
            
            <nav class="main-nav">
                <a href="adminDashboard.html" class="nav-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="adminTemplates.html" class="nav-item">
                    <i class="fas fa-clone"></i>
                    <span>Templates</span>
                </a>
                <a href="adminUsers.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </a>
                <a href="adminForms.html" class="nav-item">
                    <i class="fas fa-file-alt"></i>
                    <span>All Forms</span>
                </a>
                <a href="adminSubmissions.html" class="nav-item">
                    <i class="fas fa-paper-plane"></i>
                    <span>Submissions</span>
                </a>
            </nav>
            
            <div class="user-profile">
                <div class="profile-image">
                    <img src="../asserts/profile.png" alt="Admin Profile">
                </div>
                <div class="profile-info">
                    <h3 id="adminName">Admin</h3>
                    <p>Administrator</p>
                </div>
                <button class="profile-menu-btn" id="profileMenuBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-content" id="profileDropdown">
                    <a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </aside>

        <main class="content-area">
            <header class="content-header">
                <div class="header-title">
                    <h1>Admin Dashboard</h1>
                    <p>Overview of your FormCraft platform</p>
                </div>
            </header>

            <div class="card-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Total Users</h3>
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="card-content">
                        <p id="totalUsers">0</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Total Forms</h3>
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="card-content">
                        <p id="totalForms">0</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Published Forms</h3>
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="card-content">
                        <p id="publishedForms">0</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Templates</h3>
                        <i class="fas fa-clone"></i>
                    </div>
                    <div class="card-content">
                        <p id="totalTemplates">0</p>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h3 class="card-title">Recent Activity</h3>
                    <i class="fas fa-history"></i>
                </div>
                <div class="card-content">
                    <ul id="activityList" style="list-style: none; padding: 0;">
                        </ul>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));

        if (!token || !user || user.role !== 'admin') {
            window.location.href = 'signin.html';
            return;
        }

        document.getElementById('adminName').textContent = user.fullName || 'Admin';

        document.getElementById('profileMenuBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('profileDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-profile')) {
                document.getElementById('profileDropdown').style.display = 'none';
            }
        });

        document.getElementById('logout').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'signin.html';
        });

        await loadDashboardData();
    });

    async function loadDashboardData() {
        try {
            const response = await fetch('http://localhost:5000/api/admin/dashboard', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load dashboard data');
            }
            
            const { data } = await response.json();
            
            document.getElementById('totalUsers').textContent = data.userCount;
            document.getElementById('totalForms').textContent = data.formCount;
            document.getElementById('publishedForms').textContent = data.publishedForms;
            document.getElementById('totalTemplates').textContent = data.templateCount || 0;
            
            renderRecentActivities(data.recentActivities || []);
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            alert('Failed to load dashboard data');
        }
    }

    function renderRecentActivities(activities) {
        const activityList = document.getElementById('activityList');
        activityList.innerHTML = '';
        
        if (activities.length === 0) {
            activityList.innerHTML = '<p class="empty-state">No recent activities</p>';
            return;
        }
        
        activities.forEach(activity => {
            const activityItem = document.createElement('li');
            activityItem.style.padding = '10px 0';
            activityItem.style.borderBottom = '1px solid #f0f0f0';
            let icon = '';
            let color = '';
            
            switch(activity.type) {
                case 'user':
                    icon = 'fas fa-user-plus';
                    color = '#4361ee';
                    break;
                case 'form':
                    icon = 'fas fa-file-alt';
                    color = '#45a049';
                    break;
                case 'response':
                    icon = 'fas fa-paper-plane';
                    color = '#ffc107';
                    break;
                default:
                    icon = 'fas fa-bell';
                    color = '#6c757d';
            }
            
            activityItem.innerHTML = `
                <i class="${icon}" style="color: ${color}; margin-right: 10px;"></i>
                ${activity.message} <strong>${activity.entity}</strong> <small>(${new Date(activity.timestamp).toLocaleString()})</small>
            `;
            
            activityList.appendChild(activityItem);
        });
    }
    </script>
</body>
</html>