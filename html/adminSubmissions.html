<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Submissions | FormCraft</title>
    <link rel="stylesheet" href="../css/adminDashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo-container">
                <img src="https://cdn3.iconfinder.com/data/icons/files-7-1/64/50-512.png" alt="FormCraft Logo">
                <h1>FormCraft</h1>
            </div>
            
            <nav class="main-nav">
                <a href="adminDashboard.html" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="adminTemplates.html" class="nav-item">
                    <i class="fas fa-clone"></i>
                    <span>Templates</span>
                </a>
                <a href="adminUsers.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </a>
                <a href="adminForms.html" class="nav-item">
                    <i class="fas fa-file-alt"></i>
                    <span>All Forms</span>
                </a>
                <a href="adminSubmissions.html" class="nav-item active">
                    <i class="fas fa-paper-plane"></i>
                    <span>Submissions</span>
                </a>
            </nav>
            
            <div class="user-profile">
                <div class="profile-image">
                    <img src="../asserts/profile.png" alt="Admin Profile">
                </div>
                <div class="profile-info">
                    <h3 id="adminName">Admin</h3>
                    <p>Administrator</p>
                </div>
                <button class="profile-menu-btn" id="profileMenuBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-content" id="profileDropdown">
                    <a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </aside>

        <main class="content-area">
            <header class="content-header">
                <div class="header-title">
                    <h1>All Submissions</h1>
                    <p>View all responses across all forms</p>
                </div>
            </header>

            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h3 class="card-title">Filter by Form</h3>
                </div>
                <div class="card-content">
                    <select id="formFilterSelect" style="width: 100%; padding: 0.5rem; font-size: 1rem; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="all">All Forms</option>
                    </select>
                </div>
            </div>

            <table class="full-width-table">
                <thead>
                    <tr>
                        <th>Form Title</th>
                        <th>Submitted By</th>
                        <th>Submitted At</th>
                        <th>Response Data</th>
                    </tr>
                </thead>
                <tbody id="submissionsTableBody">
                    </tbody>
            </table>
            <div id="loadingMessage" class="empty-state">Loading submissions...</div>
            <div id="noDataMessage" class="empty-state" style="display:none;">No submissions found.</div>
        </main>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));

        if (!token || !user || user.role !== 'admin') {
            window.location.href = 'signin.html';
            return;
        }

        document.getElementById('adminName').textContent = user.fullName || 'Admin';

        document.getElementById('profileMenuBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('profileDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-profile')) {
                document.getElementById('profileDropdown').style.display = 'none';
            }
        });

        document.getElementById('logout').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'signin.html';
        });

        const formFilterSelect = document.getElementById('formFilterSelect');
        formFilterSelect.addEventListener('change', () => {
            loadAllResponses(formFilterSelect.value);
        });

        await populateFormFilter();
        await loadAllResponses('all');
    });

    let allResponses = [];

    async function populateFormFilter() {
        const formFilterSelect = document.getElementById('formFilterSelect');
        try {
            const response = await fetch('http://localhost:5000/api/admin/forms', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const { data: forms } = await response.json();
            
            forms.forEach(form => {
                const option = document.createElement('option');
                option.value = form._id;
                option.textContent = form.title;
                formFilterSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to load forms for filter:', error);
        }
    }

    async function loadAllResponses(filterFormId = 'all') {
        const submissionsTableBody = document.getElementById('submissionsTableBody');
        const loadingMessage = document.getElementById('loadingMessage');
        const noDataMessage = document.getElementById('noDataMessage');

        loadingMessage.style.display = 'block';
        submissionsTableBody.innerHTML = '';
        noDataMessage.style.display = 'none';

        try {
            if (allResponses.length === 0) {
                const response = await fetch('http://localhost:5000/api/admin/responses', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load submissions');
                
                const { data: submissions } = await response.json();
                allResponses = submissions;
            }

            loadingMessage.style.display = 'none';
            
            let filteredResponses = allResponses;
            if (filterFormId !== 'all') {
                filteredResponses = allResponses.filter(res => res.form._id === filterFormId);
            }

            if (filteredResponses.length === 0) {
                noDataMessage.style.display = 'block';
                return;
            }

            filteredResponses.forEach(submission => {
                const formTitle = submission.form ? submission.form.title : 'Deleted Form';
                const submittedBy = submission.submittedBy ? submission.submittedBy.fullName : 'Anonymous';
                const submittedAt = new Date(submission.createdAt).toLocaleString();
                const responseData = submission.responses.map(res => `<strong>${res.fieldId}:</strong> ${res.value}`).join('<br>');

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formTitle}</td>
                    <td>${submittedBy}</td>
                    <td>${submittedAt}</td>
                    <td>${responseData}</td>
                `;
                submissionsTableBody.appendChild(row);
            });
        } catch (error) {
            console.error('Error loading submissions:', error);
            loadingMessage.textContent = 'Error loading submissions: ' + error.message;
        }
    }
    </script>
</body>
</html>