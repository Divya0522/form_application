<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
        }

        header {
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        #logoContainer {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #logoContainer img {
            width: 30px;
            height: 30px;
        }

        #logoContainer a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
            font-size: 1.2rem;
        }

        #buttonsHeader {
            display: flex;
            gap: 10px;
        }

        #buttonsHeader button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #buttonsHeader button:hover {
            background-color: #e0e0e0;
        }

        #buttonsHeader button i {
            font-size: 14px;
        }

        #publishBtn {
            background-color: #4CAF50;
            color: white;
        }

        #publishBtn:hover {
            background-color: #45a049;
        }
        /* Add this to your existing CSS */
#buttonsHeader button:nth-child(4) i.fa-spinner {
    margin-right: 5px;
}

#buttonsHeader button:nth-child(4) i.fa-check {
    color: #4CAF50;
    margin-right: 5px;
}

        main {
            max-width: 1000px;
            margin: 20px auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .form-header {
            margin-bottom: 30px;
            position: relative;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .form-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .form-header p {
            color: #666;
        }

        .form-header #icons {
            position: absolute;
            right: 20px;
            top: 20px;
        }

        .questionBlock {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            position: relative;
            background-color: white;
        }

        .questionBlock:hover {
            border-color: #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        #form-group {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #form-group label {
            font-weight: 500;
            font-size: 16px;
            flex-grow: 1;
        }

        #icons {
            display: flex;
            gap: 15px;
        }

        #icons i {
            cursor: pointer;
            color: #666;
            font-size: 18px;
        }

        #icons i:hover {
            color: #333;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-top: 10px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        input[type="radio"],
        input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        button[type="submit"] {
            background-color: rgb(0, 60, 139);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            font-weight: 500;
        }

        button[type="submit"]:hover {
            background-color: rgb(0, 50, 120);
        }

        #addContent {
            display: none;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #container input[type="text"] {
            padding: 12px;
            border: none;
            border-bottom: 2px solid #ddd;
            font-size: 16px;
            width: 100%;
        }

        #container input[type="text"]:focus {
            outline: none;
            border-bottom-color: rgb(0, 60, 139);
        }

        #custom-select {
            position: relative;
            width: 100%;
        }

        #selected {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
        }

        #options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        #options li {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #options li:hover {
            background-color: #f5f5f5;
        }

        #options hr {
            margin: 5px 0;
            border: none;
            border-top: 1px solid #eee;
        }

        #inputContainer {
            margin-top: 20px;
        }

        #actions {
            display: flex;
            gap: 15px;
            list-style: none;
            margin-top: 20px;
            padding: 0;
        }

        #actions li {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            color: #555;
        }

        #actions li i {
            font-size: 18px;
        }

        .toggle-switch {
            display: inline-block;
            position: relative;
        }

        .fa-toggle-on {
            color: #4CAF50;
        }

        .fa-toggle-off {
            color: #ccc;
        }

        .add-question-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            background-color: white;
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            color: #555;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .add-question-btn:hover {
            background-color: #f9f9f9;
            border-color: #999;
            color: #333;
        }

        .add-question-btn i {
            font-size: 20px;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .error-message {
            color: #d32f2f;
            text-align: center;
            padding: 30px;
        }

        .error-message button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Response view specific styles */
        .response-mode .form-header {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .response-mode .questionBlock {
            background-color: #f9f9f9;
            border: none;
        }

        .response-mode #icons {
            display: none;
        }

        /* Thank you message */
        .thank-you-message {
            text-align: center;
            padding: 50px 20px;
            display: none;
        }

        .thank-you-message h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .thank-you-message p {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #buttonsHeader {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            #buttonsHeader button {
                margin-bottom: 5px;
            }
            
            .form-header, .questionBlock {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div id="logoContainer">
            <img src="https://cdn3.iconfinder.com/data/icons/files-7-1/64/50-512.png" alt="FormCraft Logo">
            <span><a href="#">FormCraft</a></span>
        </div>
        <div id="buttonsHeader">
            <button onclick="undoAction()"><i class="fas fa-undo"></i> Undo</button>
            <button onclick="redoAction()"><i class="fas fa-redo"></i> Redo</button>
            <button onclick="previewForm()"><i class="fas fa-eye"></i> Preview</button>
            <button onclick="saveForm()"><i class="fas fa-save"></i> Save</button>
            <button id="shareBtn"><i class="fas fa-share"></i> Share</button>
            <button id="publishBtn"><i class="fas fa-globe"></i> Publish</button>
        </div>
    </header>

    <main>
        <form id="surveyForm">
            <div class="form-header">
                <h1 contenteditable="true">Untitled Form</h1>
                <p contenteditable="true">Form description</p>
                <div id="icons">
                    <i class="fas fa-edit" onclick="editElement(event)"></i>
                </div>
            </div>
            
            <div id="questionsContainer"></div>
            
            <div class="add-question-btn" onclick="showAddQuestionPanel()">
                <i class="fas fa-plus-circle"></i>
                <span>Add Question</span>
            </div>
            
            <div id="addContent">
                <div id="container">
                    <input type="text" placeholder="Question">
                    <div id="custom-select">
                        <div id="selected">Select type of answer <i class="fas fa-caret-down"></i></div>
                        <ul id="options">
                            <li><i class="fa fa-pen"></i>Short Answer</li>
                            <li><i class="fa fa-align-left"></i>Paragraph</li>
                            <hr>
                            <li><i class="fa fa-dot-circle"></i>Multiple Choice</li>
                            <li><i class="fa fa-check-square"></i>Checkboxes</li>
                            <li><i class="fa fa-caret-down"></i>Dropdown</li>
                            <hr>
                            <li><i class="fa fa-upload"></i>File Upload</li>
                            <hr>
                            <li><i class="fa fa-sliders-h"></i>Linear Scaling</li>
                            <li><i class="fa fa-star"></i>Rating</li>
                            <hr>
                            <li><i class="fa fa-calendar-alt"></i>Date</li>
                            <li><i class="fa fa-clock"></i>Time</li>
                        </ul>
                    </div>
                    <div id="inputContainer"></div>
                    <ul id="actions">
                        <!-- <li><i class="fa fa-copy" onclick="copyQuestion()"></i> Duplicate</li>
                        <li><i class="fa fa-trash-alt" onclick="deleteQuestion()"></i> Delete</li> -->
                        <li>
                            <span class="toggle-switch">
                                <i class="fa fa-toggle-off" id="toggleRequired"></i>
                            </span>Required
                        </li>
                        <li><i class="fas fa-save" onclick="saveQuestion(event)"></i> Save</li>
                    </ul>
                </div>
            </div>
            
            <div class="thank-you-message">
                <h2>Thank You!</h2>
                <p>Your response has been submitted successfully.</p>
                <button onclick="window.location.href = '/'">Return Home</button>
            </div>
        </form>
    </main>

    <script>
       
        let currentFormId = null;
        let formStates = [];
        let currentStateIndex = -1;
        let isResponseMode = false;

       document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('token');
    const urlParams = new URLSearchParams(window.location.search);
     const templateId = urlParams.get('template');

          if (templateId) {
        try {
            const response = await fetch(`http://localhost:5000/api/admin/templates/${templateId}`);
            if (!response.ok) throw new Error('Template not found');
            
            const { data: template } = await response.json();
            loadFormData(template);
            
            // Update form title to indicate it's a new form based on template
            document.querySelector('.form-header h1').textContent = `Copy of ${template.title}`;
            currentFormId = null; // This will be a new form
        } catch (error) {
            console.error('Error loading template:', error);
            alert('Error loading template: ' + error.message);
        }
    }
    document.getElementById('buttonsHeader').querySelector('button:nth-child(4)').addEventListener('click', saveForm);
    const sharedFormId = urlParams.get('shared_form');
    
    if (sharedFormId) {
        isResponseMode = true;
        await loadSharedForm(sharedFormId);
    } else {
        if (!token) {
            window.location.href = 'signin.html';
            return;
        }

        currentFormId = urlParams.get('id');
        
        if (currentFormId) {
            try {
                const response = await fetch(`http://localhost:5000/api/forms/${currentFormId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const { data: form } = await response.json();
                    loadFormData(form);
                    updatePublishButton(form.isPublished);
                } else {
                    throw new Error('Failed to load form');
                }
            } catch (error) {
                console.error('Error loading form:', error);
                alert('Error loading form: ' + error.message);
            }
        } else {
            initializeFormStates();
        }
    }
    
    setupEventListeners();
    document.getElementById('publishBtn').addEventListener('click', publishForm);
    document.getElementById('shareBtn').addEventListener('click', shareForm);
});

   async function shareForm() {
    if (!currentFormId) {
        const saved = await saveForm();
        if (!saved) {
            alert('Please save the form first before sharing');
            return;
        }
    }

    try {
        // First check if the form is published
        const formResponse = await fetch(`http://localhost:5000/api/forms/${currentFormId}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!formResponse.ok) {
            throw new Error('Failed to fetch form details');
        }
        
        const { data: form } = await formResponse.json();
        
        if (!form.isPublished) {
            alert('Please publish the form first before sharing');
            return;
        }
        
        // Generate the correct public URL
        const publicUrl = `${window.location.origin}/form.html?id=${currentFormId}`;
        showShareDialog(publicUrl);
    } catch (error) {
        console.error('Error sharing form:', error);
        alert('Error sharing form: ' + error.message);
    }
}
async function loadSharedForm(formId) {
            try {
                const response = await fetch(`http://localhost:5000/api/forms/${formId}/view`);
                
                if (response.ok) {
                    const { data: form } = await response.json();
                    
                  
                    document.body.classList.add('response-mode');
                    
                   
                    document.getElementById('buttonsHeader').style.display = 'none';
                    
                  
                    loadFormData(form);
                   
                    document.getElementById('surveyForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await submitResponse(formId);
                    });
                } else {
                    throw new Error('Form not found or not published');
                }
            } catch (error) {
                console.error('Error loading shared form:', error);
                document.getElementById('questionsContainer').innerHTML = `
                    <div class="error-message">
                        <p>Error loading form: ${error.message}</p>
                        <button onclick="window.location.href = '/'">Return Home</button>
                    </div>
                `;
            }
        }

  // Update the setupEventListeners function to include dropdown handling
function setupEventListeners() {
    // Add input event listeners to all editable elements
    document.querySelectorAll('[contenteditable="true"]').forEach(el => {
        el.addEventListener('input', saveFormState);
    });
    // Add this to your setupEventListeners function
document.getElementById('toggleRequired').addEventListener('click', function() {
    this.classList.toggle('fa-toggle-on');
    this.classList.toggle('fa-toggle-off');
});

    // Add event listeners for question operations
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('fa-trash') || 
            e.target.classList.contains('fa-edit') || 
            e.target.classList.contains('fa-plus-circle')) {
            saveFormState();
        }
    });

    // Handle dropdown selection
    document.getElementById('selected').addEventListener('click', function(e) {
        e.stopPropagation();
        const options = document.getElementById('options');
        options.style.display = options.style.display === 'block' ? 'none' : 'block';
    });

    // Handle option selection
    document.getElementById('options').addEventListener('click', function(e) {
        if (e.target.tagName === 'LI') {
            const selectedText = e.target.textContent;
            document.getElementById('selected').innerHTML = selectedText + ' <i class="fas fa-caret-down"></i>';
            document.getElementById('options').style.display = 'none';
            displayContent(selectedText);
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#custom-select')) {
            document.getElementById('options').style.display = 'none';
        }
    });

    // Initialize form states
    initializeFormStates();
}     
      

function showAddQuestionPanel() {
            if (isResponseMode) return;
            
            document.getElementById('addContent').style.display = 'block';
            document.querySelector('.add-question-btn').style.display = 'none';
         
            document.querySelector("#container input[type='text']").value = "";
            document.querySelector("#selected").innerHTML = "Select type of answer <i class='fas fa-caret-down'></i>";
            document.getElementById("inputContainer").innerHTML = "";
            
            if (document.getElementById("toggleRequired").classList.contains("fa-toggle-on")) {
                document.getElementById("toggleRequired").click();
            }
        }

        function hideAddQuestionPanel() {
            document.getElementById('addContent').style.display = 'none';
            document.querySelector('.add-question-btn').style.display = 'flex';
        }

        function loadFormData(form) {
          
            document.querySelector('.form-header h1').textContent = form.title;
            document.querySelector('.form-header p').textContent = form.description;
            
        
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = '';
            
        
            form.fields.forEach(field => {
                addFormField(field);
            });
            
            
            if (isResponseMode) {
                const submitButton = document.createElement('button');
                submitButton.type = 'submit';
                submitButton.textContent = 'Submit';
                questionsContainer.appendChild(submitButton);
            }
            
           
            if (!isResponseMode) {
                initializeFormStates();
            }
        }

        function addFormField(field) {
            const questionsContainer = document.getElementById('questionsContainer');
            const newQuestionBlock = document.createElement("div");
            newQuestionBlock.className = "questionBlock";
            
            let inputHTML = '';
            const fieldId = field.id || field.label.toLowerCase().replace(/\s+/g, '-');
            
            switch(field.type) {
                case 'text':
                case 'email':
                case 'number':
                case 'date':
                case 'time':
                    inputHTML = `
                        <input type="${field.type}" 
                               id="${fieldId}" 
                               name="${fieldId}"
                               ${field.required ? 'required' : ''}
                               ${field.placeholder ? `placeholder="${field.placeholder}"` : ''}
                               ${field.min ? `min="${field.min}"` : ''}
                               ${field.max ? `max="${field.max}"` : ''}>
                    `;
                    break;
                case 'textarea':
                    inputHTML = `
                        <textarea id="${fieldId}" 
                                  name="${fieldId}"
                                  ${field.required ? 'required' : ''}
                                  ${field.placeholder ? `placeholder="${field.placeholder}"` : ''}></textarea>
                    `;
                    break;
                case 'radio':
                case 'checkbox':
                    inputHTML = generateOptions(field);
                    break;
                case 'select':
                    inputHTML = generateSelect(field);
                    break;
                case 'rating':
                    inputHTML = generateRating(field);
                    break;
                default:
                    inputHTML = `<input type="text" id="${fieldId}" name="${fieldId}" ${field.required ? 'required' : ''}>`;
            }
        
            if (isResponseMode) {
                newQuestionBlock.innerHTML = `
                    <div id="form-group">
                        <label>${field.label} ${field.required ? '<span style="color:red">*</span>' : ''}</label>
                    </div>
                    ${inputHTML}
                `;
            } else {
                newQuestionBlock.innerHTML = `
                    <div id="form-group">
                        <label contenteditable="true">${field.label}</label>
                        <div id="icons">
                            <i class="fas fa-plus-circle" onclick="addNewQuestionAfter(event)"></i>
                            <i class="fas fa-edit" onclick="editElement(event)"></i>
                            <i class="fas fa-trash" onclick="deleteElement(event)"></i>
                        </div>
                    </div>
                    ${inputHTML}
                `;
            }
            
            questionsContainer.appendChild(newQuestionBlock);
        }

        function addNewQuestionAfter(event) {
            const questionBlock = event.target.closest('.questionBlock');
            showAddQuestionPanel();
            
          
            if (questionBlock) {
                questionBlock.insertAdjacentElement('afterend', document.getElementById('addContent'));
            }
        }

        function initializeFormStates() {
    formStates = [getFormHTML()];
    currentStateIndex = 0;
    updateUndoRedoButtons();
}
       function getFormHTML() {
    const formHeader = document.querySelector('.form-header').cloneNode(true);
    const questionsContainer = document.getElementById('questionsContainer').cloneNode(true);
    
    // Clean up cloned elements
    formHeader.querySelectorAll('[contenteditable="true"]').forEach(el => {
        el.contentEditable = false;
    });
    
    return {
        header: formHeader.innerHTML,
        questions: questionsContainer.innerHTML
    };
}

function updateUndoRedoButtons() {
    const undoBtn = document.querySelector('#buttonsHeader button:nth-child(1)');
    const redoBtn = document.querySelector('#buttonsHeader button:nth-child(2)');
    
    undoBtn.disabled = currentStateIndex <= 0;
    redoBtn.disabled = currentStateIndex >= formStates.length - 1;
}

       
        function undoAction() {
    if (currentStateIndex > 0) {
        currentStateIndex--;
        restoreFormState();
    }
    updateUndoRedoButtons();
}

function redoAction() {
    if (currentStateIndex < formStates.length - 1) {
        currentStateIndex++;
        restoreFormState();
    }
    updateUndoRedoButtons();
}

       function restoreFormState() {
    if (currentStateIndex < 0 || currentStateIndex >= formStates.length) return;
    
    const state = formStates[currentStateIndex];
    document.querySelector('.form-header').innerHTML = state.header;
    document.getElementById('questionsContainer').innerHTML = state.questions;
    
    // Reattach event listeners to editable elements
    document.querySelectorAll('[contenteditable="true"]').forEach(el => {
        el.contentEditable = true;
        el.addEventListener('input', saveFormState);
    });
}
       function saveFormState() {
    // If we're not at the latest state, discard future states
    if (currentStateIndex < formStates.length - 1) {
        formStates = formStates.slice(0, currentStateIndex + 1);
    }
    
    // Save new state
    formStates.push(getFormHTML());
    currentStateIndex++;
    
    // Limit history to 50 states
    if (formStates.length > 50) {
        formStates.shift();
        currentStateIndex--;
    }
    
    updateUndoRedoButtons();
}
        function previewForm() {
           
            const formClone = document.querySelector('form').cloneNode(true);
               formClone.querySelectorAll('#icons').forEach(icons => {
                icons.remove();
            });
            
            formClone.querySelector('.add-question-btn').remove();
            
            
            if (formClone.querySelector('#addContent')) {
                formClone.querySelector('#addContent').remove();
            }
            
            formClone.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.contentEditable = false;
            });
            
         
            const previewModal = document.createElement('div');
            previewModal.style.position = 'fixed';
            previewModal.style.top = '0';
            previewModal.style.left = '0';
            previewModal.style.width = '100%';
            previewModal.style.height = '100%';
            previewModal.style.backgroundColor = 'rgba(0,0,0,0.8)';
            previewModal.style.display = 'flex';
            previewModal.style.justifyContent = 'center';
            previewModal.style.alignItems = 'center';
            previewModal.style.zIndex = '2000';
       
            const previewContent = document.createElement('div');
            previewContent.style.backgroundColor = 'white';
            previewContent.style.padding = '20px';
            previewContent.style.borderRadius = '8px';
            previewContent.style.width = '80%';
            previewContent.style.maxWidth = '800px';
            previewContent.style.maxHeight = '90vh';
            previewContent.style.overflowY = 'auto';
            
          
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close Preview';
            closeBtn.style.marginTop = '20px';
            closeBtn.style.padding = '10px 20px';
            closeBtn.style.backgroundColor = 'rgb(0, 60, 139)';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(previewModal);
            });
           
            previewContent.appendChild(formClone);
            previewContent.appendChild(closeBtn);
            previewModal.appendChild(previewContent);
           
            document.body.appendChild(previewModal);
        }

function displayContent(ele) {
    const inputContainer = document.getElementById("inputContainer");
    inputContainer.innerHTML = "";
    const isRequired = document.getElementById("toggleRequired").classList.contains("fa-toggle-on");
    
    if (ele === "Short Answer") {
        inputContainer.innerHTML = `<input type='text' placeholder='Short answer text' ${isRequired ? 'required' : ''}>`;
    } else if (ele === "Paragraph") {
        inputContainer.innerHTML = `<textarea rows='3' cols='40' ${isRequired ? 'required' : ''}></textarea>`;
    } else if (ele === "Multiple Choice") {
        const options = prompt("Enter options separated by commas (e.g., Option 1, Option 2, Option 3)");
        if (options) {
            const optionList = options.split(',').map(opt => opt.trim());
            inputContainer.innerHTML = generateOptions({
                type: "radio",
                id: "temp_" + Date.now(),
                options: optionList,
                required: isRequired
            });
        }
    } else if (ele === "Checkboxes") {
        const options = prompt("Enter options separated by commas (e.g., Option 1, Option 2, Option 3)");
        if (options) {
            const optionList = options.split(',').map(opt => opt.trim());
            inputContainer.innerHTML = generateOptions({
                type: "checkbox",
                id: "temp_" + Date.now(),
                options: optionList,
                required: isRequired
            });
        }
    } else if (ele === "Dropdown") {
        const options = prompt("Enter options separated by commas (e.g., Option 1, Option 2, Option 3)");
         if (options) {
            const optionList = options.split(',').map(opt => opt.trim());
            inputContainer.innerHTML = generateSelect({
                type:"select",
                id: "temp_" + Date.now(),
                options: optionList,
                required: isRequired
            });
        }
    } else if (ele === "File Upload") {
        inputContainer.innerHTML = `<input type='file' ${isRequired ? 'required' : ''}>`;
    } 
    else if (ele === "Linear Scaling") {
    let max = parseInt(prompt("Enter max range: "));
    let min = parseInt(prompt("Enter min range: "));
    const placeholder = prompt("Enter placeholder text (e.g., 'Rate from 1 to 5'):");
    inputContainer.innerHTML = `<input type='number' max=${max} min=${min} ${isRequired ? 'required' : ''}
    placeholder="${placeholder || `Enter number between ${min} and ${max}`}">`;
}
    
    else if (ele === "Date") {
        inputContainer.innerHTML = `<input type='date' ${isRequired ? 'required' : ''}>`;
    } else if (ele === "Time") {
        inputContainer.innerHTML = `<input type='time' ${isRequired ? 'required' : ''}>`;
    } else if (ele === "Rating") {
        const maxRating = prompt("Enter maximum rating (default 5):", "5");
        const ratingCount = parseInt(maxRating) || 5;
        inputContainer.innerHTML = generateRating({
            id: "temp_" + Date.now(),
            max: ratingCount,
            required: isRequired
        });
    }
}

 function generateOptionsInput(type) {
        const container = document.createElement("div");
        container.className = "options-container";
      
        const questionInput = document.createElement("input");
        questionInput.type = "text";
        questionInput.placeholder = "Enter your question here";
        questionInput.className = "question-input";
        container.appendChild(questionInput);
        
      
        const optionsContainer = document.createElement("div");
        optionsContainer.className = "options-list";
      
        for (let i = 0; i < 2; i++) {
            optionsContainer.appendChild(createOptionInput(i, type));
        }
        
        container.appendChild(optionsContainer);
        
        const addButton = document.createElement("button");
        addButton.type = "button";
        addButton.textContent = "+ Add Option";
        addButton.className = "add-option-btn";
        addButton.onclick = () => {
            const optionCount = optionsContainer.querySelectorAll(".option-input").length;
            optionsContainer.appendChild(createOptionInput(optionCount, type));
        };
        container.appendChild(addButton);
        
        return container.outerHTML;
    }

 function createOptionInput(index, type) {
        const optionDiv = document.createElement("div");
        optionDiv.className = "option-input";
        
        const input = document.createElement("input");
        input.type = type === "select" ? "text" : type;
        if (type !== "select") {
            input.name = "option_group_" + Date.now();  
        }
        input.placeholder = `Option ${index + 1}`;
        input.className = "option-text";
        
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "×";
        removeBtn.className = "remove-option-btn";
        removeBtn.onclick = (e) => {
            e.target.parentElement.remove();
        };
        
        optionDiv.appendChild(input);
        optionDiv.appendChild(removeBtn);
        return optionDiv;
    }

function generateRatingInput() {
  const container = document.createElement("div");
  
  const maxRating = prompt("Enter maximum rating (default 5):", "5");
  const ratingCount = parseInt(maxRating) || 5;
  
  for (let i = 1; i <= ratingCount; i++) {
    const star = document.createElement("span");
    star.textContent = "★";
    star.style.fontSize = "24px";
    star.style.cursor = "pointer";
    star.style.marginRight = "5px";
    star.onclick = () => {
      alert(`Selected rating: ${i}`);
    };
    container.appendChild(star);
  }
  
  return container.outerHTML;
}

    function generateOptions(field) {
    const container = document.createElement("div");
    container.style.marginTop = "10px";
    
    field.options.forEach((option) => {
        const id = `${field.id}_${option.replace(/\s+/g, '-').toLowerCase()}`;
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.marginBottom = "8px";
        label.style.cursor = "pointer";
        
        const input = document.createElement("input");
        input.type = field.type;
        input.name = field.id; 
        input.value = option;
        input.id = id;
        if (field.required) input.required = true;
        
        const optionText = document.createElement("span");
        optionText.textContent = option;
        optionText.style.marginLeft = "8px";
        
        label.appendChild(input);
        label.appendChild(optionText);
        container.appendChild(label);
    });
    
    return container.outerHTML;
}  


function generateSelect(field) {
    const select = document.createElement("select");
    select.id = field.id;
    select.name = field.id;
    select.style.marginTop = "10px";
    select.style.width = "100%";
    select.style.padding = "8px";
    select.style.borderRadius = "4px";
    if (field.required) select.required = true;
    
  
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "-- Select an option --";
    defaultOption.disabled = true;
    defaultOption.selected = true;
    select.appendChild(defaultOption);
    
   
    field.options.forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
    
    return select.outerHTML;
}

      function generateRating(field) {
            const container = document.createElement("div");
            container.className = "stars";
            container.style.marginTop = "10px";
            container.style.display = "flex";
            container.style.gap = "10px";
            
            for (let i = 1; i <= field.max; i++) {
                const label = document.createElement("label");
                label.htmlFor = `rating_${i}`;
                label.style.cursor = "pointer";
                label.style.fontSize = "24px";
                label.style.color = "#ffc107";
                
                const input = document.createElement("input");
                input.type = "radio";
                input.name = "rating";
                input.id = `rating_${i}`;
                input.value = i.toString();
                input.style.display = "none";
                if (field.required && i === 1) input.required = true;
                
                label.appendChild(input);
                label.appendChild(document.createTextNode("★"));
                container.appendChild(label);
            }
            
            return container.outerHTML;
        }
function getFieldType(uiType) {
  const typeMap = {
    'Short Answer': 'text',
    'Paragraph': 'textarea',
    'Multiple Choice': 'radio',
    'Checkboxes': 'checkbox',
    'Dropdown': 'dropdown',  // Must match schema
    'File Upload': 'file',
    'Linear Scaling': 'range',
    'Rating': 'rating',
    'Date': 'date',
    'Time': 'time'
  };
  return typeMap[uiType] || 'text';
}
function saveQuestion(event) {
    event.preventDefault();
    
    const questionInput = document.querySelector("#container input[type='text']");
    const questionText = questionInput.value.trim();
    
    if (!questionText) {
        alert("Please enter a question first");
        return;
    }
    const fieldId = questionText.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
    const answerType = document.querySelector("#selected").textContent.trim().replace(' <i class="fas fa-caret-down"></i>', '');
    const inputContainer = document.getElementById("inputContainer");
    const isRequired = document.getElementById("toggleRequired").classList.contains("fa-toggle-on");
    
    const questionId = questionText.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
    
    let inputHTML = '';
    const field = {
        id: fieldId,
        label: questionText,
        required: isRequired,
        type: getFieldType(answerType)
    };
    
    switch(answerType) {
        case "Short Answer":
            inputHTML = `<input type="text" id="${questionId}" name="${questionId}" ${isRequired ? 'required' : ''}>`;
            break;
        case "Paragraph":
            inputHTML = `<textarea id="${questionId}" name="${questionId}" ${isRequired ? 'required' : ''}></textarea>`;
            break;
        case "Multiple Choice":
            field.options = [];
            inputContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
                field.options.push(radio.value);
            });
            inputHTML = generateOptions(field);
            break;
        case "Checkboxes":
            field.options = [];
            inputContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                field.options.push(checkbox.value);
            });
            inputHTML = generateOptions(field);
            break;
        case "Dropdown":
            field.options = [];
            const select = inputContainer.querySelector('select');
            if (select) {
                select.querySelectorAll('option').forEach(option => {
                    if (option.value && option.textContent !== "-- Select an option --") {
                        field.options.push(option.textContent);
                    }
                });
            }
            inputHTML = generateSelect(field);
            break;
        case "File Upload":
            inputHTML = `<input type="file" id="${questionId}" name="${questionId}" ${isRequired ? 'required' : ''}>`;
            break;
        case "Rating":
            field.max = inputContainer.querySelectorAll('input[type="radio"]').length;
            inputHTML = generateRating(field);
            break;
        default:
            inputHTML = `<input type="text" id="${questionId}" name="${questionId}" ${isRequired ? 'required' : ''}>`;
    }
    
    const newQuestionBlock = document.createElement("div");
    newQuestionBlock.className = "questionBlock";
    
    newQuestionBlock.innerHTML = `
        <div id="form-group">
            <label contenteditable="true">${questionText}</label>
            <div id="icons">
                <i class="fas fa-plus-circle" onclick="addNewQuestionAfter(event)"></i>
                <i class="fas fa-edit" onclick="editElement(event)"></i>
                <i class="fas fa-trash" onclick="deleteElement(event)"></i>
            </div>
        </div>
        ${inputHTML}
    `;
    
    const addContent = document.getElementById("addContent");
    if (addContent.previousElementSibling) {
        addContent.previousElementSibling.insertAdjacentElement('afterend', newQuestionBlock);
    } else {
        document.getElementById('questionsContainer').appendChild(newQuestionBlock);
    }
    
    hideAddQuestionPanel();
    saveFormState();
}

function generateRadioOptions(name, options, isRequired) {
        const container = document.createElement("div");
        container.style.marginTop = "10px";
        
        options.forEach((option, index) => {
            const id = `${name}_${index}`;
            const label = document.createElement("label");
            label.style.display = "flex";
            label.style.alignItems = "center";
            label.style.marginBottom = "8px";
            label.style.cursor = "pointer";
            
            const input = document.createElement("input");
            input.type = "radio";
            input.name = name;
            input.value = option.value;
            input.id = id;
            if (isRequired) input.required = true;
            
            const optionText = document.createElement("span");
            optionText.textContent = option.text;
            optionText.style.marginLeft = "8px";
            
            label.appendChild(input);
            label.appendChild(optionText);
            container.appendChild(label);
        });
        
      
        const otherLabel = document.createElement("label");
        otherLabel.style.display = "flex";
        otherLabel.style.alignItems = "center";
        otherLabel.style.marginTop = "8px";
        otherLabel.style.cursor = "pointer";
        
        const otherInput = document.createElement("input");
        otherInput.type = "radio";
        otherInput.name = name;
        otherInput.value = "Other";
        otherInput.id = name + "_other";
        if (isRequired) otherInput.required = true;
        
        const otherText = document.createElement("span");
        otherText.textContent = "Other";
        otherText.style.marginLeft = "8px";
        
        otherLabel.appendChild(otherInput);
        otherLabel.appendChild(otherText);
        container.appendChild(otherLabel);
        
        return container.outerHTML;
    }

    function generateSelectOptions(name, options, isRequired) {
        const select = document.createElement("select");
        select.name = name;
        select.id = name;
        if (isRequired) select.required = true;
        
   
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "-- Select --";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        select.appendChild(defaultOption);
      
        options.forEach((option, index) => {
            const opt = document.createElement("option");
            opt.value = option.value;
            opt.textContent = option.text;
            select.appendChild(opt);
        });
        
      
        const otherOption = document.createElement("option");
        otherOption.value = "Other";
        otherOption.textContent = "Other";
        select.appendChild(otherOption);
        
        return select.outerHTML;
    }

 function generateCheckboxOptions(name, options, isRequired) {
        const container = document.createElement("div");
        container.style.marginTop = "10px";
        
        options.forEach((option, index) => {
            const id = `${name}_${index}`;
            const label = document.createElement("label");
            label.style.display = "flex";
            label.style.alignItems = "center";
            label.style.marginBottom = "8px";
            label.style.cursor = "pointer";
            
            const input = document.createElement("input");
            input.type = "checkbox";
            input.name = name + "[]";
            input.value = option.value;
            input.id = id;
            if (isRequired) input.required = true;
            
            const optionText = document.createElement("span");
            optionText.textContent = option.text;
            optionText.style.marginLeft = "8px";
            
            label.appendChild(input);
            label.appendChild(optionText);
            container.appendChild(label);
        });
        
 
        const otherLabel = document.createElement("label");
        otherLabel.style.display = "flex";
        otherLabel.style.alignItems = "center";
        otherLabel.style.marginTop = "8px";
        otherLabel.style.cursor = "pointer";
        
        const otherInput = document.createElement("input");
        otherInput.type = "checkbox";
        otherInput.name = name + "[]";
        otherInput.value = "Other";
        otherInput.id = name + "_other";
        if (isRequired) otherInput.required = true;
        
        const otherText = document.createElement("span");
        otherText.textContent = "Other";
        otherText.style.marginLeft = "8px";
        
        otherLabel.appendChild(otherInput);
        otherLabel.appendChild(otherText);
        container.appendChild(otherLabel);
        
        return container.outerHTML;
    }


        function copyQuestion() {
    const addContent = document.getElementById("addContent");
    if (!addContent) return;
    
    let prevElement = addContent.previousElementSibling;
    while (prevElement && !prevElement.classList.contains('questionBlock')) {
        prevElement = prevElement.previousElementSibling;
    }
    
    if (!prevElement) {
        alert("No question found to duplicate");
        return;
    }
    
    const clonedBlock = prevElement.cloneNode(true);
    
   
    const inputs = clonedBlock.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        if (input.id) {
            input.id = input.id + '_' + Date.now();
        }
        if (input.name) {
            input.name = input.name + '_' + Date.now();
        }
    });
    
    addContent.insertAdjacentElement('beforebegin', clonedBlock);
    saveFormState();
}



function deleteQuestion() {
    const addContent = document.getElementById("addContent");
    if (!addContent) return;
 
    let prevElement = addContent.previousElementSibling;
    while (prevElement && !prevElement.classList.contains('questionBlock')) {
        prevElement = prevElement.previousElementSibling;
    }
    
    if (!prevElement) {
        alert("No question found to delete");
        return;
    }
    
    if (confirm("Are you sure you want to delete this question?")) {
        prevElement.remove();
        saveFormState();
    }
}

        function deleteElement(event) {
            const questionBlock = event.target.closest('.questionBlock');
            if (!questionBlock) return;
            
            if (confirm("Are you sure you want to delete this question?")) {
                questionBlock.remove();
                saveFormState();
            }
        }

        function editElement(event) {
            const questionBlock = event.target.closest('.questionBlock');
            const formHeader = event.target.closest('.form-header');
            
            if (formHeader) {
             
                const title = formHeader.querySelector('h1').textContent;
                const description = formHeader.querySelector('p').textContent;
                
                const newTitle = prompt("Edit form title:", title);
                if (newTitle !== null && newTitle !== title) {
                    formHeader.querySelector('h1').textContent = newTitle;
                    saveFormState();
                }
                
                const newDesc = prompt("Edit form description:", description);
                if (newDesc !== null && newDesc !== description) {
                    formHeader.querySelector('p').textContent = newDesc;
                    saveFormState();
                }
                return;
            }
            
            if (!questionBlock) return;
         
            const label = questionBlock.querySelector('label');
            const currentText = label.textContent;
            const newText = prompt("Edit your question:", currentText);
            
            if (newText !== null && newText !== currentText) {
                label.textContent = newText;
                saveFormState();
            }
        }

        function updatePublishButton(isPublished) {
            const publishBtn = document.getElementById("publishBtn");
            if (isPublished) {
                publishBtn.innerHTML = '<i class="fas fa-globe"></i> Published';
                publishBtn.style.backgroundColor = '#4CAF50';
                publishBtn.onclick = unpublishForm;
            } else {
                publishBtn.innerHTML = '<i class="fas fa-globe"></i> Publish';
                publishBtn.style.backgroundColor = '';
                publishBtn.onclick = publishForm;
            }
        }

   
async function publishForm() {
    if (!currentFormId) {
        const saved = await saveForm();
        if (!saved) {
            alert('Please save the form before publishing');
            return false;
        }
    }

    try {
        const response = await fetch(`http://localhost:5000/api/forms/${currentFormId}/publish`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to publish form');
        }

        const { data } = await response.json();
        updatePublishButton(data.isPublished);
        alert('Form published successfully!');
        return true;
    } catch (error) {
        console.error('Error publishing form:', error);
        alert(`Error publishing form: ${error.message}`);
        return false;
    }
}

async function unpublishForm() {
            try {
                const response = await fetch(`http://localhost:5000/api/forms/${currentFormId}/unpublish`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    updatePublishButton(false);
                    alert('Form unpublished successfully!');
                } else {
                    throw new Error('Failed to unpublish form');
                }
            } catch (error) {
                console.error('Error unpublishing form:', error);
                alert('Error unpublishing form. Please try again.');
            }
        }

async function saveForm() {
    try {
        // Get form data from contenteditable elements
        const title = document.querySelector('.form-header h1').textContent;
        const description = document.querySelector('.form-header p').textContent;
        
        const formData = {
            title: title,
            description: description,
            fields: []
        };

        // Collect all form fields from question blocks
        document.querySelectorAll('.questionBlock').forEach(block => {
            const label = block.querySelector('label').textContent;
            const input = block.querySelector('input, textarea, select');
            
            if (!input) return;

            const field = {
    id: input.id || `field_${Date.now()}`,
    type: input.tagName === 'SELECT' ? 'dropdown' :
          input.tagName === 'TEXTAREA' ? 'textarea' :
          input.type || 'text',
    label: label,
    required: input.required || false
};


            // Handle different field types
            switch(field.type) {
                case 'radio':
                case 'checkbox':
                    field.options = [];
                    block.querySelectorAll(`input[type="${field.type}"]`).forEach(opt => {
                        field.options.push(opt.value || opt.nextElementSibling?.textContent?.trim());
                    });
                    break;
                    
                case 'dropdown':
                    field.options = [];
                    block.querySelectorAll('option').forEach(opt => {
                        if (opt.value) field.options.push(opt.textCfontent);
                    });
                    break;
            }

            formData.fields.push(field);
        });

        const method = currentFormId ? 'PUT' : 'POST';
        const url = currentFormId 
            ? `http://localhost:5000/api/forms/${currentFormId}`
            : 'http://localhost:5000/api/forms';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to save form');
        }

        const result = await response.json();
        
        // If this is a new form, store the ID
        if (!currentFormId && result.data?._id) {
            currentFormId = result.data._id;
            // Update URL to include the new ID
            window.history.pushState({}, '', `formEditor.html?id=${currentFormId}`);
        }

        // Show save confirmation
        const saveBtn = document.querySelector('#buttonsHeader button:nth-child(4)');
        saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
        setTimeout(() => {
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
        }, 2000);

        return true;
    } catch (error) {
        console.error('Error saving form:', error);
        alert('Error saving form: ' + error.message);
        return false;
    }
}

function getFormStructure() {
    const title = document.querySelector('.form-header h1')?.textContent || 'Untitled Form';
    const description = document.querySelector('.form-header p')?.textContent || '';
    
    const fields = [];
    document.querySelectorAll('.questionBlock').forEach((block) => {
        const label = block.querySelector('label');
        if (!label) return;

        // Get the input element to determine type
        const input = block.querySelector('input, textarea, select');
        if (!input) return;

        const field = {
            label: label.textContent,
            id: input.id || `field_${Date.now()}`,
            type: input.type || (input.tagName === 'TEXTAREA' ? 'textarea' : 
                               input.tagName === 'SELECT' ? 'dropdown' : 'text'), // Changed to 'dropdown'
            required: input.required || false
        };

        // Handle different field types
        switch(field.type) {
            case 'radio':
            case 'checkbox':
                field.options = [];
                block.querySelectorAll(`input[type="${field.type}"]`).forEach(opt => {
                    field.options.push(opt.value || opt.nextElementSibling?.textContent?.trim());
                });
                break;
                
            case 'dropdown':
                field.options = [];
                block.querySelectorAll('option').forEach(opt => {
                    if (opt.value) field.options.push(opt.textContent);
                });
                break;
                
            case 'text':
            case 'textarea':
                if (input.placeholder) {
                    field.placeholder = input.placeholder;
                }
                break;
                
            case 'number':
            case 'range':
                if (input.min) field.min = input.min;
                if (input.max) field.max = input.max;
                break;
        }

        fields.push(field);
    });
    
    return { 
        title, 
        description, 
        fields,
        isPublished: false
    };
}
function copyQuestion() {
    const addContent = document.getElementById("addContent");
    if (!addContent) return;
    
    let prevElement = addContent.previousElementSibling;
    while (prevElement && !prevElement.classList.contains('questionBlock')) {
        prevElement = prevElement.previousElementSibling;
    }
    
    if (!prevElement) {
        alert("No question found to duplicate");
        return;
    }
    
    const clonedBlock = prevElement.cloneNode(true);
    addContent.insertAdjacentElement('beforebegin', clonedBlock);
   
    saveFormState();
}

function deleteQuestion() {
    const addContent = document.getElementById("addContent");
    if (!addContent) return;
    
  
    let prevElement = addContent.previousElementSibling;
    while (prevElement && !prevElement.classList.contains('questionBlock')) {
        prevElement = prevElement.previousElementSibling;
    }
    
    if (!prevElement) {
        alert("No question found to delete");
        return;
    }
    
    if (confirm("Are you sure you want to delete this question?")) {
        prevElement.remove();
        saveFormState();
    }
}

 function showShareDialog(publicUrl) {
    const shareModal = document.createElement('div');
    shareModal.style.position = 'fixed';
    shareModal.style.top = '0';
    shareModal.style.left = '0';
    shareModal.style.width = '100%';
    shareModal.style.height = '100%';
    shareModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    shareModal.style.display = 'flex';
    shareModal.style.justifyContent = 'center';
    shareModal.style.alignItems = 'center';
    shareModal.style.zIndex = '2000';
    
    shareModal.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px;">
            <h2 style="margin-top: 0;">Share Your Form</h2>
            <p>Anyone with this link can respond to your form:</p>
            <div style="display: flex; margin: 15px 0;">
                <input type="text" id="shareUrlInput" value="${publicUrl}" readonly 
                    style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px 0 0 4px;">
                <button onclick="copyToClipboard('shareUrlInput')" 
                        style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer;">
                    Copy
                </button>
            </div>
            <div style="margin-top: 20px;">
                <button onclick="shareVia('email', '${publicUrl}')" 
                        style="padding: 8px 15px; margin-right: 10px; background: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Email
                </button>
                <button onclick="shareVia('whatsapp', '${publicUrl}')" 
                        style="padding: 8px 15px; background: #25D366; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    WhatsApp
                </button>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)" 
                        style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(shareModal);
}

async function submitResponse(formId) {
    try {
        const responses = [];
        const formFields = document.querySelectorAll('.questionBlock');
        
        formFields.forEach(fieldDiv => {
            const input = fieldDiv.querySelector('input, textarea, select');
            if (!input) return;
            
            const fieldId = input.id;
            let value;
            
            if (input.type === 'checkbox') {
                // For checkboxes, collect all checked values
                value = Array.from(fieldDiv.querySelectorAll('input[type="checkbox"]:checked'))
                            .map(checkbox => checkbox.value);
            } else if (input.type === 'radio') {
                // For radio buttons, get selected value
                const selected = fieldDiv.querySelector('input[type="radio"]:checked');
                value = selected ? selected.value : null;
            } else if (input.tagName === 'SELECT') {
                value = input.value;
            } else {
                value = input.value;
            }
            
            if (value !== null && value !== undefined && value !== '') {
                responses.push({
                    fieldId,
                    value
                });
            }
        });

        const response = await fetch(`http://localhost:5000/api/responses/${formId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ responses })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Submission failed');
        }

        document.getElementById('surveyForm').style.display = 'none';
        document.querySelector('.thank-you-message').style.display = 'block';
    } catch (error) {
        console.error('Submission error:', error);
        document.getElementById('errorMessage').textContent = 'Error submitting form: ' + error.message;
        document.getElementById('errorMessage').style.display = 'block';
    }
}
        window.copyToClipboard = function(elementId) {
            const input = document.getElementById(elementId);
            input.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        };

        window.shareVia = function(method, url) {
            const subject = 'Please fill out this form';
            const body = `I'd like you to fill out this form: ${url}`;
            
            if (method === 'email') {
                window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
            } else if (method === 'whatsapp') {
                window.open(`https://wa.me/?text=${encodeURIComponent(body)}`);
            }
        };
    </script>
</body>
</html>