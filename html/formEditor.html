<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        header {
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        #logoContainer {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #logoContainer img {
            width: 30px;
            height: 30px;
        }
        
        #logoContainer a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        #buttonsHeader {
            display: flex;
            gap: 10px;
        }
        
        #buttonsHeader button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }
        
        #buttonsHeader button:hover {
            background-color: #e0e0e0;
        }
        
        #buttonsHeader button i {
            font-size: 14px;
        }
        
        #publishBtn {
            background-color: #4CAF50;
            color: white;
        }
        
        #publishBtn:hover {
            background-color: #45a049;
        }
        
        #buttonsHeader button:nth-child(4) i.fa-spinner {
            margin-right: 5px;
        }
        
        #buttonsHeader button:nth-child(4) i.fa-check {
            color: #4CAF50;
            margin-right: 5px;
        }
        
        main {
            max-width: 1000px;
            margin: 20px auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .form-header {
            margin-bottom: 30px;
            position: relative;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .form-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            outline: none;
        }
        
        .form-header p {
            color: #666;
            outline: none;
        }
        
        .form-header #icons {
            position: absolute;
            right: 20px;
            top: 20px;
        }
        
        #questionsContainer {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .questionBlock {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            position: relative;
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .questionBlock:hover {
            border-color: #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        #form-group {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #form-group label {
            font-weight: 500;
            font-size: 16px;
            flex-grow: 1;
            outline: none;
        }
        
        #icons {
            display: flex;
            gap: 15px;
        }
        
        #icons i {
            cursor: pointer;
            color: #666;
            font-size: 18px;
            transition: color 0.2s;
        }
        
        #icons i:hover {
            color: #333;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-top: 10px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #4361ee;
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        input[type="radio"],
        input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        button[type="submit"] {
            background-color: rgb(0, 60, 139);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        button[type="submit"]:hover {
            background-color: rgb(0, 50, 120);
        }
        
        #addContent {
            display: none;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        #container input[type="text"] {
            padding: 12px;
            border: none;
            border-bottom: 2px solid #ddd;
            font-size: 16px;
            width: 100%;
            transition: border-color 0.3s;
        }
        
        #container input[type="text"]:focus {
            outline: none;
            border-bottom-color: rgb(0, 60, 139);
        }
        
        #custom-select {
            position: relative;
            width: 100%;
        }
        
        #selected {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            transition: border-color 0.3s;
        }
        
        #selected:hover {
            border-color: #aaa;
        }
        
        #options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        #options li {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
        }
        
        #options li:hover {
            background-color: #f5f5f5;
        }
        
        #options hr {
            margin: 5px 0;
            border: none;
            border-top: 1px solid #eee;
        }
        
        #inputContainer {
            margin-top: 20px;
        }
        
        #actions {
            display: flex;
            gap: 15px;
            list-style: none;
            margin-top: 20px;
            padding: 0;
        }
        
        #actions li {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            color: #555;
            transition: color 0.2s;
        }
        
        #actions li:hover {
            color: #333;
        }
        
        #actions li i {
            font-size: 18px;
        }
        
        .toggle-switch {
            display: inline-block;
            position: relative;
        }
        
        .fa-toggle-on {
            color: #4CAF50;
        }
        
        .fa-toggle-off {
            color: #ccc;
        }
        
        .add-question-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            background-color: white;
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            color: #555;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .add-question-btn:hover {
            background-color: #f9f9f9;
            border-color: #999;
            color: #333;
        }
        
        .add-question-btn i {
            font-size: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .error-message {
            color: #d32f2f;
            text-align: center;
            padding: 30px;
        }
        
        .error-message button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .error-message button:hover {
            background-color: #b71c1c;
        }
        
        .response-mode .form-header {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .response-mode .questionBlock {
            background-color: #f9f9f9;
            border: none;
        }
        
        .response-mode #icons {
            display: none;
        }
        
        .thank-you-message {
            text-align: center;
            padding: 50px 20px;
            display: none;
        }
        
        .thank-you-message h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #4CAF50;
        }
        
        .thank-you-message p {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }
        
        .thank-you-message button {
            padding: 10px 20px;
            background-color: #4361ee;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .thank-you-message button:hover {
            background-color: #3a56d4;
        }
        
        .required-star {
            color: red;
            margin-left: 4px;
        }
        
        .range-container {
            margin-top: 15px;
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            #buttonsHeader {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            #buttonsHeader button {
                margin-bottom: 5px;
            }
            
            .form-header, .questionBlock {
                padding: 15px;
            }
            
            #icons {
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div id="logoContainer">
            <img src="https://cdn3.iconfinder.com/data/icons/files-7-1/64/50-512.png" alt="FormCraft Logo">
            <span><a href="#">FormCraft</a></span>
        </div>
        <div id="buttonsHeader">
            <button onclick="undoAction()"><i class="fas fa-undo"></i> Undo</button>
            <button onclick="redoAction()"><i class="fas fa-redo"></i> Redo</button>
            <button onclick="previewForm()"><i class="fas fa-eye"></i> Preview</button>
            <button onclick="saveForm()"><i class="fas fa-save"></i> Save</button>
            <button id="shareBtn"><i class="fas fa-share"></i> Share</button>
            <button id="publishBtn"><i class="fas fa-globe"></i> Publish</button>
        </div>
    </header>

    <main>
        <form id="surveyForm">
            <div class="form-header">
                <h1 contenteditable="true">Untitled Form</h1>
                <p contenteditable="true">Form description</p>
                <div id="icons">
                    <i class="fas fa-edit" onclick="editElement(event)"></i>
                </div>
            </div>
            
            <div id="questionsContainer"></div>
            
            <div class="add-question-btn" onclick="showAddQuestionPanel()">
                <i class="fas fa-plus-circle"></i>
                <span>Add Question</span>
            </div>
            
            <div id="addContent">
                <div id="container">
                    <input type="text" placeholder="Question" id="newQuestionText">
                    <div id="custom-select">
                        <div id="selected">Select type of answer <i class="fas fa-caret-down"></i></div>
                        <ul id="options">
                            <li><i class="fa fa-pen"></i>Short Answer</li>
                            <li><i class="fa fa-align-left"></i>Paragraph</li>
                            <li><i class="fa fa-hashtag"></i>Number</li> <!-- Added Number field -->
                            <hr>
                            <li><i class="fa fa-dot-circle"></i>Multiple Choice</li>
                            <li><i class="fa fa-check-square"></i>Checkboxes</li>
                            <li><i class="fa fa-caret-down"></i>Dropdown</li>
                            <hr>
                            <li><i class="fa fa-upload"></i>File Upload</li>
                            <hr>
                            <li><i class="fa fa-sliders-h"></i>Linear Scaling</li>
                            <li><i class="fa fa-star"></i>Rating</li>
                            <hr>
                            <li><i class="fa fa-calendar-alt"></i>Date</li>
                            <li><i class="fa fa-clock"></i>Time</li>
                        </ul>
                    </div>
                    <div id="inputContainer"></div>
                    <ul id="actions">
                        <li>
                            <span class="toggle-switch">
                                <i class="fa fa-toggle-off" id="toggleRequired"></i>
                            </span>Required
                        </li>
                        <li><i class="fas fa-save" onclick="saveQuestion(event)"></i> Save</li>
                    </ul>
                </div>
            </div>
            
            <div class="thank-you-message">
                <h2>Thank You!</h2>
                <p>Your response has been submitted successfully.</p>
                <button onclick="window.location.href = '/'">Return Home</button>
            </div>
        </form>
    </main>

    <script>
        let currentFormId = null;
        let formStates = [];
        let currentStateIndex = -1;
        let isResponseMode = false;

        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const urlParams = new URLSearchParams(window.location.search);
            const templateId = urlParams.get('template');
            const formId = urlParams.get('id');
            const sharedFormId = urlParams.get('shared_form');

            if (!token && !sharedFormId) {
                window.location.href = 'signin.html';
                return;
            }

            if (templateId) {
                await loadTemplate(templateId);
            } else if (sharedFormId) {
                isResponseMode = true;
                await loadSharedForm(sharedFormId);
            } else if (formId) {
                currentFormId = formId;
                await loadForm(currentFormId);
            } else {
                initializeFormStates();
            }

            setupEventListeners();
            document.getElementById('publishBtn').addEventListener('click', publishForm);
            document.getElementById('shareBtn').addEventListener('click', shareForm);
        });

        async function loadTemplate(templateId) {
            try {
                const response = await fetch(`http://localhost:5000/api/forms/templates/${templateId}`, {
                    headers: localStorage.getItem('token') ? {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    } : {}
                });
                if (!response.ok) throw new Error('Template not found');
                const { data: template } = await response.json();
                loadFormData(template);
            } catch (error) {
                console.error('Error loading template:', error);
                alert('Error loading template: ' + error.message);
            }
        }

        async function loadForm(formId) {
            try {
                const response = await fetch(`http://localhost:5000/api/forms/${formId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (!response.ok) throw new Error('Failed to load form');
                const { data: form } = await response.json();
                loadFormData(form);
                updatePublishButton(form.isPublished);
            } catch (error) {
                console.error('Error loading form:', error);
                alert('Error loading form: ' + error.message);
            }
        }

        function loadFormData(form) {
            document.querySelector('.form-header h1').textContent = form.title || 'Untitled Form';
            document.querySelector('.form-header p').textContent = form.description || '';
            
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = '';
            
            if (form.fields && Array.isArray(form.fields)) {
                form.fields.forEach(field => {
                    addFormField(field);
                });
            }
            
            if (!isResponseMode) {
                initializeFormStates();
            }
        }
        
        async function loadSharedForm(formId) {
            try {
                const response = await fetch(`http://localhost:5000/api/forms/public/${formId}`);
                if (!response.ok) throw new Error('Form not found or not published');
                
                const { data: form } = await response.json();
                document.body.classList.add('response-mode');
                document.getElementById('buttonsHeader').style.display = 'none';
                loadFormData(form);
                
                document.getElementById('surveyForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await submitResponse(formId);
                });
            } catch (error) {
                console.error('Error loading shared form:', error);
                document.getElementById('questionsContainer').innerHTML = `
                    <div class="error-message">
                        <p>Error loading form: ${error.message}</p>
                        <button onclick="window.location.href = '/'">Return Home</button>
                    </div>
                `;
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.addEventListener('input', saveFormState);
            });
            
            document.getElementById('toggleRequired').addEventListener('click', function() {
                this.classList.toggle('fa-toggle-on');
                this.classList.toggle('fa-toggle-off');
            });
            
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('fa-trash') ||
                    e.target.classList.contains('fa-edit') ||
                    e.target.classList.contains('fa-plus-circle')) {
                    saveFormState();
                }
            });
            
            document.getElementById('selected').addEventListener('click', function(e) {
                e.stopPropagation();
                const options = document.getElementById('options');
                options.style.display = options.style.display === 'block' ? 'none' : 'block';
            });
            
            document.getElementById('options').addEventListener('click', function(e) {
                if (e.target.tagName === 'LI') {
                    const selectedText = e.target.textContent;
                    document.getElementById('selected').innerHTML = selectedText + ' <i class="fas fa-caret-down"></i>';
                    document.getElementById('options').style.display = 'none';
                    displayContent(selectedText);
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#custom-select')) {
                    document.getElementById('options').style.display = 'none';
                }
            });
        }
        
        function showAddQuestionPanel() {
            if (isResponseMode) return;
            document.getElementById('addContent').style.display = 'block';
            document.querySelector('.add-question-btn').style.display = 'none';
            document.getElementById("newQuestionText").value = "";
            document.getElementById("selected").innerHTML = "Select type of answer <i class='fas fa-caret-down'></i>";
            document.getElementById("inputContainer").innerHTML = "";
            if (document.getElementById("toggleRequired").classList.contains("fa-toggle-on")) {
                document.getElementById("toggleRequired").classList.replace("fa-toggle-on", "fa-toggle-off");
            }
        }

        function hideAddQuestionPanel() {
            document.getElementById('addContent').style.display = 'none';
            document.querySelector('.add-question-btn').style.display = 'flex';
        }
        
        function addFormField(field) {
            const questionsContainer = document.getElementById('questionsContainer');
            const newQuestionBlock = document.createElement("div");
            newQuestionBlock.className = "questionBlock";
            const requiredStar = field.required ? '<span class="required-star">*</span>' : '';
            let inputHTML = '';
            const fieldId = field.id || `field_${Date.now()}`;
            
            switch(field.type) {
                case 'text':
                case 'email':
                case 'number':  // Added number field
                case 'date':
                case 'time':
                case 'file':
                    inputHTML = `<input type="${field.type}" id="${fieldId}" name="${fieldId}" ${field.required ? 'required' : ''} ${field.placeholder ? `placeholder="${field.placeholder}"` : ''} ${field.min ? `min="${field.min}"` : ''} ${field.max ? `max="${field.max}"` : ''}>`;
                    break;
                case 'textarea':
                    inputHTML = `<textarea id="${fieldId}" name="${fieldId}" ${field.required ? 'required' : ''} ${field.placeholder ? `placeholder="${field.placeholder}"` : ''}></textarea>`;
                    break;
                case 'radio':
                case 'checkbox':
                    inputHTML = generateOptions(field);
                    break;
                case 'dropdown':
                    inputHTML = generateSelect(field);
                    break;
                case 'rating':
                    inputHTML = generateRating(field);
                    break;
                case 'range':
                    inputHTML = generateRange(field);
                    break;
                default:
                    inputHTML = `<input type="text" id="${fieldId}" name="${fieldId}" ${field.required ? 'required' : ''}>`;
            }

            if (isResponseMode) {
                newQuestionBlock.innerHTML = `<div id="form-group"><label>${field.label} ${requiredStar}</label></div>${inputHTML}`;
            } else {
                newQuestionBlock.innerHTML = `
                    <div id="form-group">
                        <label contenteditable="true">${field.label} ${requiredStar}</label>
                        <div id="icons">
                            <i class="fas fa-plus-circle" onclick="addNewQuestionAfter(event)"></i>
                            <i class="fas fa-edit" onclick="editElement(event)"></i>
                            <i class="fas fa-trash" onclick="deleteElement(event)"></i>
                        </div>
                    </div>
                    ${inputHTML}
                `;
            }
            questionsContainer.appendChild(newQuestionBlock);
        }
        
        function generateRange(field) {
            return `
                <div class="range-container">
                    <input type="range" id="${field.id}" name="${field.id}"
                        min="${field.min || 1}" max="${field.max || 5}" step="${field.step || 1}"
                        ${field.required ? 'required' : ''}>
                    <div class="range-labels">
                        <span>${field.minLabel || field.min || 1}</span>
                        <span>${field.maxLabel || field.max || 5}</span>
                    </div>
                </div>
            `;
        }

        function addNewQuestionAfter(event) {
            const questionBlock = event.target.closest('.questionBlock');
            showAddQuestionPanel();
            if (questionBlock) {
                questionBlock.insertAdjacentElement('afterend', document.getElementById('addContent'));
            }
        }

        function initializeFormStates() {
            formStates = [getFormHTML()];
            currentStateIndex = 0;
            updateUndoRedoButtons();
        }

        function getFormHTML() {
            const formHeader = document.querySelector('.form-header').cloneNode(true);
            const questionsContainer = document.getElementById('questionsContainer').cloneNode(true);
            formHeader.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.contentEditable = false;
            });
            return {
                header: formHeader.innerHTML,
                questions: questionsContainer.innerHTML
            };
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.querySelector('#buttonsHeader button:nth-child(1)');
            const redoBtn = document.querySelector('#buttonsHeader button:nth-child(2)');
            undoBtn.disabled = currentStateIndex <= 0;
            redoBtn.disabled = currentStateIndex >= formStates.length - 1;
        }

        function undoAction() {
            if (currentStateIndex > 0) {
                currentStateIndex--;
                restoreFormState();
            }
            updateUndoRedoButtons();
        }

        function redoAction() {
            if (currentStateIndex < formStates.length - 1) {
                currentStateIndex++;
                restoreFormState();
            }
            updateUndoRedoButtons();
        }

        function restoreFormState() {
            if (currentStateIndex < 0 || currentStateIndex >= formStates.length) return;
            const state = formStates[currentStateIndex];
            document.querySelector('.form-header').innerHTML = state.header;
            document.getElementById('questionsContainer').innerHTML = state.questions;
            document.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.contentEditable = true;
                el.addEventListener('input', saveFormState);
            });
        }

        function saveFormState() {
            if (currentStateIndex < formStates.length - 1) {
                formStates = formStates.slice(0, currentStateIndex + 1);
            }
            formStates.push(getFormHTML());
            currentStateIndex++;
            if (formStates.length > 50) {
                formStates.shift();
                currentStateIndex--;
            }
            updateUndoRedoButtons();
        }

        function previewForm() {
            const formClone = document.querySelector('form').cloneNode(true);
            formClone.querySelectorAll('#icons').forEach(icons => { icons.remove(); });
            formClone.querySelector('.add-question-btn').remove();
            if (formClone.querySelector('#addContent')) {
                formClone.querySelector('#addContent').remove();
            }
            formClone.querySelectorAll('[contenteditable="true"]').forEach(el => {
                el.contentEditable = false;
            });
            
            const previewModal = document.createElement('div');
            previewModal.style.position = 'fixed';
            previewModal.style.top = '0';
            previewModal.style.left = '0';
            previewModal.style.width = '100%';
            previewModal.style.height = '100%';
            previewModal.style.backgroundColor = 'rgba(0,0,0,0.8)';
            previewModal.style.display = 'flex';
            previewModal.style.justifyContent = 'center';
            previewModal.style.alignItems = 'center';
            previewModal.style.zIndex = '2000';
            
            const previewContent = document.createElement('div');
            previewContent.style.backgroundColor = 'white';
            previewContent.style.padding = '20px';
            previewContent.style.borderRadius = '8px';
            previewContent.style.width = '80%';
            previewContent.style.maxWidth = '800px';
            previewContent.style.maxHeight = '90vh';
            previewContent.style.overflowY = 'auto';
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close Preview';
            closeBtn.style.marginTop = '20px';
            closeBtn.style.padding = '10px 20px';
            closeBtn.style.backgroundColor = 'rgb(0, 60, 139)';
            closeBtn.style.color = 'white';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(previewModal);
            });
            
            previewContent.appendChild(formClone);
            previewContent.appendChild(closeBtn);
            previewModal.appendChild(previewContent);
            document.body.appendChild(previewModal);
        }

        function displayContent(ele) {
            const inputContainer = document.getElementById("inputContainer");
            inputContainer.innerHTML = "";
            const isRequired = document.getElementById("toggleRequired").classList.contains("fa-toggle-on");
            
            const createInput = (type, placeholder = '', min = '', max = '') => {
                return `<input type='${type}' placeholder='${placeholder}' ${isRequired ? 'required' : ''} ${min ? `min="${min}"` : ''} ${max ? `max="${max}"` : ''}>`;
            };

            const createSelect = (options) => {
                const optionsHtml = options.map(opt => `<option>${opt}</option>`).join('');
                return `<select ${isRequired ? 'required' : ''}>${optionsHtml}</select>`;
            };

            if (ele === "Short Answer") {
                inputContainer.innerHTML = createInput('text', 'Short answer text');
            } else if (ele === "Paragraph") {
                inputContainer.innerHTML = `<textarea rows='3' cols='40' placeholder='Long answer text' ${isRequired ? 'required' : ''}></textarea>`;
            } else if (ele === "Number") {
                // Added Number input field
                inputContainer.innerHTML = createInput('number', 'Enter a number');
            } else if (ele === "Multiple Choice") {
                const options = prompt("Enter options separated by commas (e.g., Option 1, Option 2, Option 3)");
                if (options) {
                    const optionList = options.split(',').map(opt => opt.trim());
                    inputContainer.innerHTML = generateOptions({ type: "radio", id: "temp_" + Date.now(), options: optionList, required: isRequired });
                }
            } else if (ele === "Checkboxes") {
                const options = prompt("Enter options separated by commas (e.g., Option 1, Option 2, Option 3)");
                if (options) {
                    const optionList = options.split(',').map(opt => opt.trim());
                    inputContainer.innerHTML = generateOptions({ type: "checkbox", id: "temp_" + Date.now(), options: optionList, required: isRequired });
                }
            } else if (ele === "Dropdown") {
                const options = prompt("Enter options separated by commas (e.g., Option 1, Option 2, Option 3)");
                if (options) {
                    const optionList = options.split(',').map(opt => opt.trim());
                    inputContainer.innerHTML = `<select id="temp_${Date.now()}" ${isRequired ? 'required' : ''}>
                                                  ${optionList.map(opt => `<option>${opt}</option>`).join('')}
                                                </select>`;
                }
            } else if (ele === "File Upload") {
                inputContainer.innerHTML = createInput('file', '');
            } else if (ele === "Linear Scaling") {
                let min = parseInt(prompt("Enter min range:", "1"));
                let max = parseInt(prompt("Enter max range:", "5"));
                if (isNaN(min)) min = 1;
                if (isNaN(max)) max = 5;
                inputContainer.innerHTML = createInput('range', '', min, max);
            } else if (ele === "Date") {
                inputContainer.innerHTML = createInput('date');
            } else if (ele === "Time") {
                inputContainer.innerHTML = createInput('time');
            } else if (ele === "Rating") {
                const maxRating = parseInt(prompt("Enter maximum rating (default 5):", "5")) || 5;
                inputContainer.innerHTML = generateRating({ id: "temp_" + Date.now(), max: maxRating, required: isRequired });
            }
        }

        function generateOptions(field) {
            const container = document.createElement("div");
            container.style.marginTop = "10px";
            field.options.forEach((option) => {
                const id = `${field.id}_${option.replace(/\s+/g, '-').toLowerCase()}`;
                const label = document.createElement("label");
                label.style.display = "flex";
                label.style.alignItems = "center";
                label.style.marginBottom = "8px";
                label.style.cursor = "pointer";
                const input = document.createElement("input");
                input.type = field.type;
                input.name = field.id;
                input.value = option;
                input.id = id;
                if (field.required) input.required = true;
                const optionText = document.createElement("span");
                optionText.textContent = option;
                optionText.style.marginLeft = "8px";
                label.appendChild(input);
                label.appendChild(optionText);
                container.appendChild(label);
            });
            return container.outerHTML;
        }

        function generateSelect(field) {
            const select = document.createElement("select");
            select.id = field.id;
            select.name = field.id;
            select.style.marginTop = "10px";
            select.style.width = "100%";
            select.style.padding = "8px";
            select.style.borderRadius = "4px";
            if (field.required) select.required = true;
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "-- Select an option --";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);
            field.options.forEach(option => {
                const opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            return select.outerHTML;
        }

        function generateRating(field) {
            const container = document.createElement("div");
            container.className = "stars";
            container.style.marginTop = "10px";
            container.style.display = "flex";
            container.style.gap = "10px";
            for (let i = 1; i <= field.max; i++) {
                const label = document.createElement("label");
                label.htmlFor = `rating_${i}`;
                label.style.cursor = "pointer";
                label.style.fontSize = "24px";
                label.style.color = "#ffc107";
                const input = document.createElement("input");
                input.type = "radio";
                input.name = field.id;
                input.value = i.toString();
                input.id = `rating_${i}`;
                input.style.display = "none";
                if (field.required && i === 1) input.required = true;
                label.appendChild(input);
                label.appendChild(document.createTextNode("★"));
                container.appendChild(label);
            }
            return container.outerHTML;
        }

        function getFieldType(uiType) {
            const typeMap = {
                'Short Answer': 'text',
                'Paragraph': 'textarea',
                'Number': 'number', // Added Number mapping
                'Multiple Choice': 'radio',
                'Checkboxes': 'checkbox',
                'Dropdown': 'dropdown',
                'File Upload': 'file',
                'Linear Scaling': 'range',
                'Rating': 'rating',
                'Date': 'date',
                'Time': 'time'
            };
            return typeMap[uiType] || 'text';
        }

        function saveQuestion(event) {
            event.preventDefault();
            const questionInput = document.querySelector("#container input[type='text']");
            const questionText = questionInput.value.trim();
            if (!questionText) {
                alert("Please enter a question first");
                return;
            }
            const fieldId = `field_${Date.now()}`;
            const answerType = document.querySelector("#selected").textContent.trim().replace(' <i class="fas fa-caret-down"></i>', '');
            const inputContainer = document.getElementById("inputContainer");
            const isRequired = document.getElementById("toggleRequired").classList.contains("fa-toggle-on");
            
            let field = {
                id: fieldId,
                label: questionText,
                required: isRequired,
                type: getFieldType(answerType)
            };
            
            let inputHTML = '';

            switch(field.type) {
                case 'text':
                case 'email':
                case 'number': // Added number case
                case 'date':
                case 'time':
                case 'file':
                    const inputElement = inputContainer.querySelector('input');
                    if (inputElement) {
                        field.placeholder = inputElement.placeholder || '';
                        field.min = inputElement.min || '';
                        field.max = inputElement.max || '';
                    }
                    inputHTML = `<input type="${field.type}" id="${fieldId}" name="${fieldId}" ${field.required ? 'required' : ''} ${field.placeholder ? `placeholder="${field.placeholder}"` : ''} ${field.min ? `min="${field.min}"` : ''} ${field.max ? `max="${field.max}"` : ''}>`;
                    break;
                case 'textarea':
                    const textareaElement = inputContainer.querySelector('textarea');
                    if (textareaElement) {
                        field.placeholder = textareaElement.placeholder || '';
                    }
                    inputHTML = `<textarea id="${fieldId}" name="${fieldId}" ${field.required ? 'required' : ''} ${field.placeholder ? `placeholder="${field.placeholder}"` : ''}></textarea>`;
                    break;
                case 'radio':
                case 'checkbox':
                    const optionSpans = inputContainer.querySelectorAll('span');
                    field.options = Array.from(optionSpans).map(span => span.textContent);
                    inputHTML = generateOptions(field);
                    break;
                case 'dropdown':
                    const options = inputContainer.querySelectorAll('option');
                    field.options = Array.from(options).map(opt => opt.textContent);
                    inputHTML = generateSelect(field);
                    break;
                case 'range':
                    const rangeElement = inputContainer.querySelector('input[type="range"]');
                    if (rangeElement) {
                        field.min = rangeElement.min || 1;
                        field.max = rangeElement.max || 5;
                        field.step = rangeElement.step || 1;
                    }
                    inputHTML = generateRange(field);
                    break;
                case 'rating':
                    const ratingElement = inputContainer.querySelector('.stars');
                    if (ratingElement) {
                        field.max = ratingElement.querySelectorAll('label').length;
                    }
                    inputHTML = generateRating(field);
                    break;
                default:
                    inputHTML = `<input type="text" id="${fieldId}" name="${fieldId}" ${isRequired ? 'required' : ''}>`;
            }

            const newQuestionBlock = document.createElement("div");
            newQuestionBlock.className = "questionBlock";
            newQuestionBlock.innerHTML = `
                <div id="form-group">
                    <label contenteditable="true">${questionText} ${isRequired ? '<span class="required-star">*</span>' : ''}</label>
                    <div id="icons">
                        <i class="fas fa-plus-circle" onclick="addNewQuestionAfter(event)"></i>
                        <i class="fas fa-edit" onclick="editElement(event)"></i>
                        <i class="fas fa-trash" onclick="deleteElement(event)"></i>
                    </div>
                </div>
                ${inputHTML}
            `;
            
            const addContent = document.getElementById("addContent");
            if (addContent.previousElementSibling) {
                addContent.previousElementSibling.insertAdjacentElement('afterend', newQuestionBlock);
            } else {
                document.getElementById('questionsContainer').appendChild(newQuestionBlock);
            }
            hideAddQuestionPanel();
            saveFormState();
        }

        function deleteElement(event) {
            const questionBlock = event.target.closest('.questionBlock');
            if (!questionBlock) return;
            if (confirm("Are you sure you want to delete this question?")) {
                questionBlock.remove();
                saveFormState();
            }
        }

        function editElement(event) {
            const questionBlock = event.target.closest('.questionBlock');
            const formHeader = event.target.closest('.form-header');
            if (formHeader) {
                const title = formHeader.querySelector('h1').textContent;
                const description = formHeader.querySelector('p').textContent;
                const newTitle = prompt("Edit form title:", title);
                if (newTitle !== null && newTitle !== title) {
                    formHeader.querySelector('h1').textContent = newTitle;
                    saveFormState();
                }
                const newDesc = prompt("Edit form description:", description);
                if (newDesc !== null && newDesc !== description) {
                    formHeader.querySelector('p').textContent = newDesc;
                    saveFormState();
                }
                return;
            }
            if (!questionBlock) return;
            const label = questionBlock.querySelector('label');
            const currentText = label.textContent;
            const newText = prompt("Edit your question:", currentText);
            if (newText !== null && newText !== currentText) {
                label.textContent = newText;
                saveFormState();
            }
        }

        function updatePublishButton(isPublished) {
            const publishBtn = document.getElementById("publishBtn");
            if (isPublished) {
                publishBtn.innerHTML = '<i class="fas fa-globe"></i> Published';
                publishBtn.style.backgroundColor = '#4CAF50';
                publishBtn.onclick = unpublishForm;
            } else {
                publishBtn.innerHTML = '<i class="fas fa-globe"></i> Publish';
                publishBtn.style.backgroundColor = '';
                publishBtn.onclick = publishForm;
            }
        }
        
        async function publishForm() {
            if (!currentFormId) {
                const saved = await saveForm();
                if (!saved) {
                    alert('Please save the form before publishing');
                    return false;
                }
            }
            try {
                const response = await fetch(`http://localhost:5000/api/forms/${currentFormId}/publish`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to publish form');
                }
                const { data } = await response.json();
                updatePublishButton(data.isPublished);
                alert('Form published successfully!');
                return true;
            } catch (error) {
                console.error('Error publishing form:', error);
                alert(`Error publishing form: ${error.message}`);
                return false;
            }
        }

        async function unpublishForm() {
            try {
                const response = await fetch(`http://localhost:5000/api/forms/${currentFormId}/unpublish`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    updatePublishButton(false);
                    alert('Form unpublished successfully!');
                } else {
                    throw new Error('Failed to unpublish form');
                }
            } catch (error) {
                console.error('Error unpublishing form:', error);
                alert('Error unpublishing form. Please try again.');
            }
        }

        async function saveForm() {
            try {
                const title = document.querySelector('.form-header h1').textContent;
                const description = document.querySelector('.form-header p').textContent;
                const formData = {
                    title: title,
                    description: description,
                    fields: []
                };
                
                document.querySelectorAll('.questionBlock').forEach(block => {
                    const labelElement = block.querySelector('label');
                    if (!labelElement) return;
                    const label = labelElement.textContent.replace(/\s*\*+$/, '').trim();
                    const input = block.querySelector('input, textarea, select');
                    if (!input) return;
                    
                    const field = {
                        id: input.id || `field_${Date.now()}`,
                        type: input.tagName === 'SELECT' ? 'dropdown' :
                            input.tagName === 'TEXTAREA' ? 'textarea' :
                            input.type || 'text',
                        label: label,
                        required: input.required || false
                    };
                    
                    switch(field.type) {
                        case 'radio':
                        case 'checkbox':
                            field.options = Array.from(block.querySelectorAll(`input[type="${field.type}"]`)).map(opt => opt.value || opt.nextElementSibling?.textContent?.trim());
                            break;
                        case 'dropdown':
                            field.options = Array.from(block.querySelectorAll('option')).map(opt => opt.textContent).filter(text => text !== "-- Select an option --");
                            break;
                        case 'range':
                            field.min = input.min || 1;
                            field.max = input.max || 5;
                            field.step = input.step || 1;
                            break;
                        case 'rating':
                            field.max = block.querySelectorAll('label[for^="rating_"]').length;
                            break;
                        case 'text':
                        case 'email':
                        case 'number': // Added number field
                        case 'date':
                        case 'time':
                        case 'file':
                        case 'textarea':
                            if (input.placeholder) field.placeholder = input.placeholder;
                            if (input.min) field.min = input.min;
                            if (input.max) field.max = input.max;
                            break;
                    }
                    
                    formData.fields.push(field);
                });
                
                const method = currentFormId ? 'PUT' : 'POST';
                const url = currentFormId
                    ? `http://localhost:5000/api/forms/${currentFormId}`
                    : 'http://localhost:5000/api/forms';
                    
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save form');
                }
                
                const result = await response.json();
                if (!currentFormId && result.data?._id) {
                    currentFormId = result.data._id;
                    window.history.pushState({}, '', `formEditor.html?id=${currentFormId}`);
                }
                
                const saveBtn = document.querySelector('#buttonsHeader button:nth-child(4)');
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                }, 2000);
                
                return true;
            } catch (error) {
                console.error('Error saving form:', error);
                alert('Error saving form: ' + error.message);
                return false;
            }
        }
        
        async function shareForm() {
            if (!currentFormId) {
                const saved = await saveForm();
                if (!saved) {
                    alert('Please save the form first before sharing');
                    return;
                }
            }
            try {
                const published = await publishForm();
                if (!published) return;

                const publicUrl = `${window.location.origin}/form.html?shared_form=${currentFormId}`;
                showShareDialog(publicUrl);
            } catch (error) {
                console.error('Error sharing form:', error);
                alert('Error sharing form: ' + error.message);
            }
        }

        function showShareDialog(publicUrl) {
            const shareModal = document.createElement('div');
            shareModal.style.position = 'fixed';
            shareModal.style.top = '0';
            shareModal.style.left = '0';
            shareModal.style.width = '100%';
            shareModal.style.height = '100%';
            shareModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            shareModal.style.display = 'flex';
            shareModal.style.justifyContent = 'center';
            shareModal.style.alignItems = 'center';
            shareModal.style.zIndex = '2000';
            
            shareModal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px;">
                    <h2 style="margin-top: 0;">Share Your Form</h2>
                    <p>Anyone with this link can respond to your form:</p>
                    <div style="display: flex; margin: 15px 0;">
                        <input type="text" id="shareUrlInput" value="${publicUrl}" readonly
                                style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px 0 0 4px;">
                        <button onclick="copyToClipboard('shareUrlInput')"
                                style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer;">
                            Copy
                        </button>
                    </div>
                    <div style="margin-top: 20px;">
                        <button onclick="shareVia('email', '${publicUrl}')"
                                style="padding: 8px 15px; margin-right: 10px; background: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Email
                        </button>
                        <button onclick="shareVia('whatsapp', '${publicUrl}')"
                                style="padding: 8px 15px; background: #25D366; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            WhatsApp
                        </button>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="document.body.removeChild(this.parentElement.parentElement.parentElement)"
                                style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(shareModal);
        }

        async function submitResponse(formId) {
            try {
                const form = document.getElementById('surveyForm');
                const responses = [];
                let hasErrors = false;
                
                document.querySelectorAll('.questionBlock').forEach(block => {
                    const label = block.querySelector('label');
                    if (!label) return;
                    
                    const fieldId = block.querySelector('input, textarea, select')?.id;
                    if (!fieldId) return;
                    
                    const field = {
                        id: fieldId,
                        required: label.innerHTML.includes('required-star')
                    };
                    
                    let value = null;
                    try {
                        const existingError = block.querySelector('.field-error');
                        if (existingError) existingError.remove();

                        const input = block.querySelector('input');
                        const textarea = block.querySelector('textarea');
                        const select = block.querySelector('select');
                        
                        if (input) {
                            if (input.type === 'checkbox') {
                                value = Array.from(block.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                            } else if (input.type === 'radio') {
                                const selectedRadio = block.querySelector('input[type="radio"]:checked');
                                value = selectedRadio ? selectedRadio.value : null;
                            } else if (input.type === 'file') {
                                value = input.files.length > 0 ? input.files[0].name : null;
                            } else {
                                value = input.value;
                            }
                        } else if (textarea) {
                            value = textarea.value;
                        } else if (select) {
                            value = select.value;
                        }
                        
                        if (field.required) {
                            if (value === null || value === '' || value === undefined || (Array.isArray(value) && value.length === 0)) {
                                throw new Error('This field is required');
                            }
                        }
                        
                        responses.push({ fieldId: field.id, value });
                    } catch (error) {
                        hasErrors = true;
                        const errorEl = document.createElement('div');
                        errorEl.className = 'field-error';
                        errorEl.style.color = 'red';
                        errorEl.style.marginTop = '5px';
                        errorEl.textContent = error.message;
                        block.appendChild(errorEl);
                    }
                });
                
                if (hasErrors) {
                    alert('Please fix the errors in the form');
                    return;
                }
                
                const response = await fetch(`http://localhost:5000/api/responses/${formId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ responses })
                });
                
                if (response.ok) {
                    form.querySelector('.thank-you-message').style.display = 'block';
                    form.style.display = 'none';
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Submission failed');
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert('Error submitting form: ' + error.message);
            }
        }
        
        window.copyToClipboard = function(elementId) {
            const input = document.getElementById(elementId);
            input.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        };

        window.shareVia = function(method, url) {
            const subject = 'Please fill out this form';
            const body = `I'd like you to fill out this form: ${url}`;
            if (method === 'email') {
                window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
            } else if (method === 'whatsapp') {
                window.open(`https://wa.me/?text=${encodeURIComponent(body)}`);
            }
        };
    </script>
</body>
</html>